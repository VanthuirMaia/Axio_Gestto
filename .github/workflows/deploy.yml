name: Deploy to Production

on:
  push:
    branches:
      - main  # Deploy autom√°tico a cada commit no main
  workflow_dispatch:  # Deploy manual tamb√©m dispon√≠vel via GitHub Actions UI

env:
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_PATH: /var/www/gestto

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django checks
        run: |
          python manage.py check --fail-level WARNING
        env:
          DJANGO_ENV: "development"
          SECRET_KEY: "ci-test-only-k8$mz9#vp2@qw5!nx7&ry4*tu6^ej3%sh1(ad0)fg-bh=lc+wo_ie"
          DEBUG: "True"

      - name: Run tests (se houver)
        run: |
          python manage.py test --verbosity=2 || echo "No tests found"
        env:
          DJANGO_ENV: "development"
          SECRET_KEY: "ci-test-only-k8$mz9#vp2@qw5!nx7&ry4*tu6^ej3%sh1(ad0)fg-bh=lc+wo_ie"
          DEBUG: "True"

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH (Docker Swarm)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ Iniciando deploy do Gestto (Docker Swarm)..."

            # Navegar para o diret√≥rio do projeto
            cd ${{ env.DEPLOY_PATH }}

            # Fazer backup do .env.prod antes de atualizar
            echo "üì¶ Fazendo backup das configura√ß√µes..."
            cp .env.prod .env.prod.backup || echo "‚ö†Ô∏è  .env.prod n√£o existe ainda"

            # Atualizar c√≥digo do GitHub
            echo "üì• Atualizando c√≥digo do reposit√≥rio..."
            git fetch origin
            git reset --hard origin/main

            # Restaurar .env.prod (n√£o vem do git)
            echo "üîê Restaurando configura√ß√µes de produ√ß√£o..."
            mv .env.prod.backup .env.prod || echo "‚ö†Ô∏è  Backup n√£o existe"

            # Verificar se o .env.prod existe (se n√£o, cria do exemplo)
            if [ ! -f .env.prod ]; then
              echo "‚ö†Ô∏è  .env.prod n√£o encontrado, criando do exemplo..."
              cp .env.prod.example .env.prod
              echo "‚ùå ERRO: Configure o .env.prod no servidor antes de continuar!"
              exit 1
            fi

            # Copiar .env.prod para .env (usado pelo Django)
            echo "üìù Copiando .env.prod para .env..."
            cp .env.prod .env

            # Build da imagem Docker
            echo "üê≥ Construindo imagem Docker..."
            docker build -t gestto-web .

            # Deploy com docker-compose
            echo "üö¢ Fazendo deploy com docker-compose..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate --no-deps web

            # Aguardar container iniciar
            echo "‚è≥ Aguardando container iniciar..."
            sleep 15

            # Verificar status dos servi√ßos
            echo "‚úÖ Verificando status dos servi√ßos..."
            docker compose -f docker-compose.prod.yml ps

            # Executar migrations (se o container web j√° estiver rodando)
            echo "üìä Executando migrations..."
            WEB_CONTAINER=$(docker ps -q -f name=gestto_web | head -1)
            if [ -n "$WEB_CONTAINER" ]; then
              docker exec $WEB_CONTAINER python manage.py migrate --noinput || echo "‚ö†Ô∏è  Migrations falharam (normal no primeiro deploy)"
              docker exec $WEB_CONTAINER python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  Collectstatic falhou"
            else
              echo "‚ö†Ô∏è  Container web ainda n√£o est√° pronto. Execute migrations manualmente."
            fi

            # Limpar recursos antigos
            echo "üßπ Limpando recursos antigos..."
            docker system prune -f

            echo ""
            echo "üéâ Deploy conclu√≠do com sucesso!"
            echo "üìç Aplica√ß√£o dispon√≠vel em: https://gestto.app.br"
            echo ""
            echo "üìä Status dos servi√ßos:"
            docker compose -f docker-compose.prod.yml ps

      - name: Health check
        run: |
          sleep 10
          curl -f https://gestto.app.br/health/ || echo "‚ö†Ô∏è  Health check falhou - verifique manualmente"

      - name: Notify deployment
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deploy realizado com sucesso!"
          else
            echo "‚ùå Deploy falhou! Verifique os logs."
          fi
