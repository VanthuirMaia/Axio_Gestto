name: Deploy to Production

on:
  push:
    branches:
      - main  # Deploy autom√°tico a cada commit no main
  workflow_dispatch:  # Deploy manual tamb√©m dispon√≠vel via GitHub Actions UI

env:
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
  DEPLOY_PATH: /var/www/gestto

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Django checks
        run: |
          python manage.py check --deploy --fail-level WARNING
        env:
          SECRET_KEY: "test-secret-key-for-ci-only"
          DEBUG: "False"
          DATABASE_URL: "sqlite:///db.sqlite3"

      - name: Run tests (se houver)
        run: |
          python manage.py test --verbosity=2 || echo "No tests found"
        env:
          SECRET_KEY: "test-secret-key-for-ci-only"
          DEBUG: "True"

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH (Docker Swarm)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e

            echo "üöÄ Iniciando deploy do Gestto (Docker Swarm)..."

            # Navegar para o diret√≥rio do projeto
            cd ${{ env.DEPLOY_PATH }}

            # Fazer backup do .env.production antes de atualizar
            echo "üì¶ Fazendo backup das configura√ß√µes..."
            cp .env.production .env.production.backup

            # Atualizar c√≥digo do GitHub
            echo "üì• Atualizando c√≥digo do reposit√≥rio..."
            git fetch origin
            git reset --hard origin/main

            # Restaurar .env.production (n√£o vem do git)
            echo "üîê Restaurando configura√ß√µes de produ√ß√£o..."
            mv .env.production.backup .env.production

            # Verificar se o .env.production existe
            if [ ! -f .env.production ]; then
              echo "‚ùå ERRO: .env.production n√£o encontrado!"
              exit 1
            fi

            # Build da imagem Docker
            echo "üê≥ Construindo imagem Docker..."
            docker build -t gestto-app:latest .

            # Carregar vari√°veis de ambiente
            echo "üìù Carregando vari√°veis de ambiente..."
            export $(cat .env.production | grep -v '^#' | xargs)

            # Deploy da stack no Swarm
            echo "üö¢ Fazendo deploy da stack gestto..."
            docker stack deploy -c gestto-stack.yaml gestto

            # Aguardar servi√ßos iniciarem
            echo "‚è≥ Aguardando servi√ßos iniciarem..."
            sleep 20

            # Verificar status dos servi√ßos
            echo "‚úÖ Verificando status dos servi√ßos..."
            docker stack services gestto

            # Executar migrations (se o servi√ßo web j√° estiver rodando)
            echo "üìä Executando migrations..."
            WEB_CONTAINER=$(docker ps -q -f name=gestto_gestto_web | head -1)
            if [ -n "$WEB_CONTAINER" ]; then
              docker exec $WEB_CONTAINER python manage.py migrate --noinput || echo "‚ö†Ô∏è  Migrations falharam (normal no primeiro deploy)"
              docker exec $WEB_CONTAINER python manage.py collectstatic --noinput || echo "‚ö†Ô∏è  Collectstatic falhou"
            else
              echo "‚ö†Ô∏è  Container web ainda n√£o est√° pronto. Execute migrations manualmente."
            fi

            # Limpar recursos antigos
            echo "üßπ Limpando recursos antigos..."
            docker system prune -f

            echo ""
            echo "üéâ Deploy conclu√≠do com sucesso!"
            echo "üìç Aplica√ß√£o dispon√≠vel em: https://app.gestto.app.br"
            echo ""
            echo "üìä Status dos servi√ßos:"
            docker stack services gestto

      - name: Health check
        run: |
          sleep 10
          curl -f https://app.gestto.app.br/health/ || echo "‚ö†Ô∏è  Health check falhou - verifique manualmente"

      - name: Notify deployment
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deploy realizado com sucesso!"
          else
            echo "‚ùå Deploy falhou! Verifique os logs."
          fi
