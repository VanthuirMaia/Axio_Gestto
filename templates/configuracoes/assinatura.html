{% extends 'base.html' %}

{% block title %}Assinatura – {{ empresa.nome }}{% endblock %}

{% block content %}
<div class="container-fluid py-4 px-4">

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="fw-bold mb-1">Gerenciar Assinatura</h2>
      <p class="text-muted mb-0">Visualize seu plano, uso e histórico de pagamentos</p>
    </div>
  </div>

  <!-- Plano Atual -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold">
              <i class="bi bi-star-fill text-warning me-2"></i>
              Plano Atual
            </h5>
            {% if assinatura.status == 'trial' %}
              <span class="badge bg-info">Trial Grátis</span>
            {% elif assinatura.status == 'ativa' %}
              <span class="badge bg-success">Ativa</span>
            {% elif assinatura.status == 'suspensa' %}
              <span class="badge bg-danger">Suspensa</span>
            {% elif assinatura.status == 'cancelada' %}
              <span class="badge bg-secondary">Cancelada</span>
            {% endif %}
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Plano</label>
              <h4 class="fw-bold mb-0">{{ plano.get_nome_display }}</h4>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Valor Mensal</label>
              <h4 class="fw-bold mb-0 text-primary">R$ {{ plano.preco_mensal|floatformat:2 }}</h4>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Gateway de Pagamento</label>
              <p class="fw-semibold mb-0">
                {% if assinatura.gateway == 'stripe' %}
                  <i class="bi bi-stripe me-1"></i> Stripe
                {% elif assinatura.gateway == 'asaas' %}
                  Asaas
                {% else %}
                  {{ assinatura.gateway|default:"Manual" }}
                {% endif %}
              </p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Data de Início</label>
              <p class="fw-semibold mb-0">{{ assinatura.data_inicio|date:"d/m/Y" }}</p>
            </div>

            {% if assinatura.status == 'trial' %}
            <div class="col-12">
              <div class="alert alert-info mb-0">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Trial ativo!</strong>
                {% if dias_restantes %}
                  Restam {{ dias_restantes }} dias de teste grátis.
                  A primeira cobrança será realizada em {{ assinatura.data_expiracao|date:"d/m/Y" }}.
                {% else %}
                  Seu período de trial está próximo do fim.
                {% endif %}
              </div>
            </div>
            {% elif assinatura.proximo_vencimento %}
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Próximo Vencimento</label>
              <p class="fw-semibold mb-0">{{ assinatura.proximo_vencimento|date:"d/m/Y" }}</p>
            </div>
            <div class="col-md-6 mb-3">
              <label class="text-muted small">Último Pagamento</label>
              <p class="fw-semibold mb-0">
                {% if assinatura.ultimo_pagamento %}
                  {{ assinatura.ultimo_pagamento|date:"d/m/Y" }}
                {% else %}
                  Nenhum pagamento ainda
                {% endif %}
              </p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Limites do Plano -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-speedometer2 me-2"></i>
            Limites do Plano
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Profissionais</small>
              <small class="fw-bold">{{ profissionais_ativos }}/{{ plano.max_profissionais }}</small>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar"
                   style="width: {{ percentual_profissionais }}%"
                   aria-valuenow="{{ percentual_profissionais }}"
                   aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <small class="text-muted">Agendamentos/mês</small>
              <small class="fw-bold">{{ agendamentos_mes }}/{{ plano.max_agendamentos_mes }}</small>
            </div>
            <div class="progress" style="height: 8px;">
              <div class="progress-bar {% if percentual_agendamentos >= 90 %}bg-danger{% elif percentual_agendamentos >= 70 %}bg-warning{% else %}bg-primary{% endif %}"
                   role="progressbar"
                   style="width: {{ percentual_agendamentos }}%"
                   aria-valuenow="{{ percentual_agendamentos }}"
                   aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>

          <hr>

          <ul class="list-unstyled mb-0 small">
            <li class="mb-2">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              {{ plano.max_usuarios }} usuário(s)
            </li>
            <li class="mb-2">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              {{ plano.max_servicos }} serviços
            </li>
            {% if plano.permite_relatorios_avancados %}
            <li class="mb-2">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              Relatórios Avançados
            </li>
            {% endif %}
            {% if plano.permite_integracao_contabil %}
            <li class="mb-2">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              Integração Contábil
            </li>
            {% endif %}
            {% if plano.permite_multi_unidades %}
            <li class="mb-2">
              <i class="bi bi-check-circle-fill text-success me-2"></i>
              Multi-unidades
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Uso Atual -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-graph-up me-2"></i>
            Uso no Mês Atual
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted mb-3">Agendamentos</h6>
              <div class="d-flex align-items-center mb-2">
                <div class="progress flex-grow-1 me-3" style="height: 25px;">
                  <div class="progress-bar {% if percentual_agendamentos >= 90 %}bg-danger{% elif percentual_agendamentos >= 70 %}bg-warning{% else %}bg-primary{% endif %}"
                       role="progressbar"
                       style="width: {{ percentual_agendamentos }}%"
                       aria-valuenow="{{ percentual_agendamentos }}"
                       aria-valuemin="0" aria-valuemax="100">
                    {{ percentual_agendamentos }}%
                  </div>
                </div>
                <span class="fw-bold">{{ agendamentos_mes }}/{{ plano.max_agendamentos_mes }}</span>
              </div>
              {% if percentual_agendamentos >= 90 %}
              <p class="text-danger small mb-0">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                Você está próximo do limite! Considere fazer upgrade.
              </p>
              {% elif percentual_agendamentos >= 70 %}
              <p class="text-warning small mb-0">
                <i class="bi bi-info-circle-fill me-1"></i>
                Você já utilizou mais de 70% do seu limite mensal.
              </p>
              {% endif %}
            </div>

            <div class="col-md-6">
              <h6 class="text-muted mb-3">Profissionais Ativos</h6>
              <div class="d-flex align-items-center mb-2">
                <div class="progress flex-grow-1 me-3" style="height: 25px;">
                  <div class="progress-bar bg-success"
                       role="progressbar"
                       style="width: {{ percentual_profissionais }}%"
                       aria-valuenow="{{ percentual_profissionais }}"
                       aria-valuemin="0" aria-valuemax="100">
                    {{ percentual_profissionais }}%
                  </div>
                </div>
                <span class="fw-bold">{{ profissionais_ativos }}/{{ plano.max_profissionais }}</span>
              </div>
              {% if percentual_profissionais >= 100 %}
              <p class="text-danger small mb-0">
                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                Limite de profissionais atingido! Faça upgrade para adicionar mais.
              </p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Histórico de Pagamentos -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-receipt me-2"></i>
            Histórico de Pagamentos
          </h5>
        </div>
        <div class="card-body">
          {% with pagamentos=assinatura.historico_pagamentos.all %}
            {% if pagamentos %}
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Data</th>
                      <th>Valor</th>
                      <th>Método</th>
                      <th>Status</th>
                      <th>ID Transação</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for pagamento in pagamentos %}
                    <tr>
                      <td>{{ pagamento.data_criacao|date:"d/m/Y H:i" }}</td>
                      <td class="fw-bold">R$ {{ pagamento.valor|floatformat:2 }}</td>
                      <td>
                        {% if pagamento.payment_method == 'card' %}
                          <i class="bi bi-credit-card me-1"></i> Cartão
                        {% elif pagamento.payment_method == 'pix' %}
                          <i class="bi bi-qr-code me-1"></i> PIX
                        {% elif pagamento.payment_method == 'boleto' %}
                          <i class="bi bi-upc me-1"></i> Boleto
                        {% else %}
                          {{ pagamento.payment_method|default:"N/A" }}
                        {% endif %}
                      </td>
                      <td>
                        {% if pagamento.status == 'aprovado' %}
                          <span class="badge bg-success">Aprovado</span>
                        {% elif pagamento.status == 'pendente' %}
                          <span class="badge bg-warning">Pendente</span>
                        {% elif pagamento.status == 'processando' %}
                          <span class="badge bg-info">Processando</span>
                        {% elif pagamento.status == 'recusado' %}
                          <span class="badge bg-danger">Recusado</span>
                        {% elif pagamento.status == 'estornado' %}
                          <span class="badge bg-secondary">Estornado</span>
                        {% else %}
                          <span class="badge bg-secondary">{{ pagamento.get_status_display }}</span>
                        {% endif %}
                      </td>
                      <td>
                        <small class="text-muted font-monospace">{{ pagamento.transaction_id|truncatechars:20 }}</small>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-4">
                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3 mb-0">
                  {% if assinatura.status == 'trial' %}
                    Você ainda está no período trial. O primeiro pagamento será processado após o término do trial.
                  {% else %}
                    Nenhum pagamento registrado ainda.
                  {% endif %}
                </p>
              </div>
            {% endif %}
          {% endwith %}
        </div>
      </div>
    </div>
  </div>

  <!-- Planos Disponíveis (Upgrade/Downgrade) -->
  {% if assinatura.status != 'cancelada' %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-arrow-up-circle me-2"></i>
            Alterar Plano
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">Compare e escolha o plano que melhor atende suas necessidades</p>

          <div class="row g-3">
            {% for plano_disponivel in planos_disponiveis %}
            <div class="col-md-4">
              <div class="card h-100 {% if plano_disponivel.id == plano.id %}border-primary{% else %}border-0{% endif %}"
                   style="{% if plano_disponivel.id == plano.id %}border-width: 2px !important;{% endif %}">
                <div class="card-body">
                  {% if plano_disponivel.id == plano.id %}
                    <span class="badge bg-primary mb-2">Plano Atual</span>
                  {% endif %}

                  <h5 class="fw-bold">{{ plano_disponivel.get_nome_display }}</h5>
                  <h3 class="text-primary fw-bold mb-3">
                    R$ {{ plano_disponivel.preco_mensal|floatformat:0 }}
                    <small class="text-muted fs-6">/mês</small>
                  </h3>

                  <ul class="list-unstyled small mb-3">
                    <li class="mb-2">
                      <i class="bi bi-check-circle-fill text-success me-2"></i>
                      {{ plano_disponivel.max_profissionais }} profissionais
                    </li>
                    <li class="mb-2">
                      <i class="bi bi-check-circle-fill text-success me-2"></i>
                      {{ plano_disponivel.max_agendamentos_mes }} agendamentos/mês
                    </li>
                    <li class="mb-2">
                      <i class="bi bi-check-circle-fill text-success me-2"></i>
                      {{ plano_disponivel.max_usuarios }} usuário(s)
                    </li>
                    <li class="mb-2">
                      <i class="bi bi-check-circle-fill text-success me-2"></i>
                      {{ plano_disponivel.max_servicos }} serviços
                    </li>
                  </ul>

                  {% if plano_disponivel.id != plano.id %}
                    {% if plano_disponivel.preco_mensal > plano.preco_mensal %}
                      <button class="btn btn-primary w-100" disabled>
                        <i class="bi bi-arrow-up me-2"></i>
                        Fazer Upgrade
                      </button>
                      <small class="text-muted d-block mt-2 text-center">Em breve</small>
                    {% else %}
                      <button class="btn btn-outline-secondary w-100" disabled>
                        <i class="bi bi-arrow-down me-2"></i>
                        Fazer Downgrade
                      </button>
                      <small class="text-muted d-block mt-2 text-center">Em breve</small>
                    {% endif %}
                  {% else %}
                    <button class="btn btn-outline-primary w-100" disabled>
                      Plano Atual
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Cancelamento -->
  {% if assinatura.status != 'cancelada' %}
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-x-circle me-2"></i>
            Cancelar Assinatura
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-warning mb-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Cancelamento de Assinatura</strong>
            <p class="mb-0 mt-2 small">
              Durante o período de trial (7 dias), você pode cancelar sem nenhuma cobrança.
              Após o trial, o cancelamento não gera reembolso, mas você mantém acesso ao sistema até o final do período pago.
            </p>
          </div>

          <p class="text-muted mb-3">
            Ao cancelar sua assinatura:
          </p>
          <ul class="text-muted small mb-3">
            <li>Você mantém acesso ao sistema até o final do período pago</li>
            <li>Não haverá novas cobranças</li>
            <li>Seus dados serão mantidos por 90 dias conforme LGPD</li>
            <li>Você pode reativar sua conta a qualquer momento dentro desse período</li>
          </ul>

          <button class="btn btn-outline-danger" disabled>
            <i class="bi bi-x-circle me-2"></i>
            Cancelar Assinatura
          </button>
          <small class="text-muted d-block mt-2">Em breve</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<style>
  .progress {
    background-color: #e9ecef;
  }

  .table th {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .hover-card {
    transition: all 0.3s ease;
  }

  .hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
  }

  .font-monospace {
    font-family: 'Courier New', monospace;
  }
</style>
{% endblock %}
