{% extends "base.html" %}

{% block title %}Calendário - {{ empresa.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/locales-all.global.min.css">

<style>
:root {
    --axio-primary: #1e3a8a;
    --axio-secondary: #fbbf24;
    --axio-success: #10b981;
    --axio-danger: #ef4444;
    --axio-info: #3b82f6;
    --axio-muted: #6b7280;
}

/* Estilo geral */
.fc {
    font-family: "Inter", sans-serif;
    font-size: 0.9rem;
}
.fc-toolbar-title {
    font-weight: 600;
}

/* Cursor pointer */
.fc-event, .fc-daygrid-event {
    cursor: pointer !important;
}

/* Status por classe */
.fc-event-pendente       { background: var(--axio-secondary) !important; color:#000 !important; }
.fc-event-confirmado     { background: var(--axio-success) !important; color:#fff !important; }
.fc-event-cancelado      { background: var(--axio-danger) !important; color:#fff !important; }
.fc-event-concluido      { background: var(--axio-info) !important; color:#fff !important; }
.fc-event-nao_compareceu { background: var(--axio-muted) !important; color:#fff !important; }

</style>
{% endblock %}

{% block content %}

<div class="container-fluid py-3">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Calendário</h3>
        <a href="{% url 'criar_agendamento' %}" class="btn btn-primary">+ Novo</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div id="calendar"></div>
        </div>
    </div>
</div>


<!-- MODAL -->
<div class="modal fade" id="eventModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">

      <h5 id="modal-title" class="fw-bold mb-2"></h5>

      <p class="mb-1"><strong>Serviço:</strong> <span id="modal-servico"></span></p>
      <p class="mb-1"><strong>Profissional:</strong> <span id="modal-profissional"></span></p>
      <p class="mb-1"><strong>Início:</strong> <span id="modal-inicio"></span></p>
      <p class="mb-1"><strong>Fim:</strong> <span id="modal-fim"></span></p>
      <p class="mb-1"><strong>Status:</strong> <span id="modal-status" class="badge bg-info"></span></p>
      <p class="mb-3"><strong>Valor:</strong> R$ <span id="modal-valor"></span></p>

      <div class="text-end mt-3">
          <a id="editBtn" href="#" class="btn btn-primary">Editar</a>
          <button id="deleteBtn" class="btn btn-danger">Excluir</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.10/locales-all.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const calendarEl = document.getElementById("calendar");

    const calendar = new FullCalendar.Calendar(calendarEl, {
        locale: "pt-br",
        timeZone: "local",
        initialView: "dayGridMonth",
        height: "auto",

        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "dayGridMonth,timeGridWeek,timeGridDay"
        },

        buttonText: {
            today: "Hoje",
            month: "Mês",
            week: "Semana",
            day: "Dia"
        },

        events(info, successCallback, failureCallback) {

            const center = new Date(info.start);
            center.setDate(center.getDate() + 7);

            const month = center.getMonth() + 1;
            const year = center.getFullYear();

            fetch(`/agendamentos/api/?mes=${month}&ano=${year}`)
                .then(r => r.json())
                .then(lista => {

                    const eventos = lista.map(ev => ({
                        id: ev.id,
                        title: ev.title,
                        start: ev.start,
                        end: ev.end,
                        classNames: ["fc-event-" + ev.status],
                        extendedProps: ev
                    }));

                    successCallback(eventos);
                })
                .catch(err => failureCallback(err));
        },

        eventClick(info) {

            const ag = info.event.extendedProps;

            document.getElementById("modal-title").innerText = ag.title;
            document.getElementById("modal-servico").innerText = ag.servico;
            document.getElementById("modal-profissional").innerText = ag.profissional || "—";
            document.getElementById("modal-inicio").innerText = new Date(info.event.start).toLocaleString("pt-BR");
            document.getElementById("modal-fim").innerText = new Date(info.event.end).toLocaleString("pt-BR");
            document.getElementById("modal-status").innerText = ag.status;
            document.getElementById("modal-valor").innerText = ag.valor.toFixed(2);

            // EDITAR
            document.getElementById("editBtn").href = `/agendamentos/editar/${ag.id}/`;

            // EXCLUIR
            document.getElementById("deleteBtn").onclick = function () {

                if (!confirm("Tem certeza que deseja excluir este agendamento?")) return;

                fetch(`/agendamentos/deletar/${ag.id}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}"
                    }
                })
                .then(() => {
                    info.event.remove();
                    bootstrap.Modal.getInstance(document.getElementById("eventModal")).hide();
                })
                .catch(err => alert("Erro ao excluir: " + err));
            };

            new bootstrap.Modal(document.getElementById("eventModal")).show();
        }
    });

    calendar.render();
});
</script>

{% endblock %}
